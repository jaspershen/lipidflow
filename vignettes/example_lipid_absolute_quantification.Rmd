---
title: "Example of lipid absolute quantification"
author:
- name: Xiaotao Shen PhD (https://www.shenxt.info/)
- affiliation: School of Medicine, Stanford University
  name: Chuchu wang PhD
  url: http://shenxt.info/
date: "Created on 2021-02-09 and updated on `r Sys.Date()`"
output:
  html_document:
    df_print: paged
    toc: no
  pdf_document:
    toc: no
vignette: >
  %\VignetteIndexEntry{example_lipid_absolute_quantification}
  %\VignettePackage{metID}
  % \VignetteEngine{knitr::rmarkdown}
  % \usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}
---

```{r, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

***

# **Demo data to show how to use `lipidflow`**

Here we use the demo data to show how to use `lipidflow` for lipid absolute quantification.

## **Organize the demo data**

First, we need to get the demo dataset.

```{r, eval=TRUE, warning=FALSE, cache=TRUE}
library(lipidflow)
library(tidyverse)
pos_data = system.file("POS", package = "lipidflow")
neg_data = system.file("NEG", package = "lipidflow")
path = file.path(".", "example")
dir.create(path)
file.copy(from = pos_data, to = path, recursive = TRUE, overwrite = TRUE)
file.copy(from = neg_data, to = path, recursive = TRUE, overwrite = TRUE)
```

Now there will be a `example` folder in your work directory. And in the `./example` folder. There are two folders: `POS` and `NEG`. The are two groups for each mode: "D25" and "M19". And each group has two repeats.

![](../man/figures/figure_3.png)

Next, we should set the match list between internal standards and lipid class.

* Positive mode:

```{r, eval=TRUE, warning=FALSE, cache=TRUE}
match_item_pos =
  list(
    "Cer" = "d18:1 (d7)-15:0 Cer",
    "ChE" = c("18:1(d7) Chol Ester", "Cholesterol (d7)"),
    "Chol" = "Cholesterol (d7)",
    "DG" = "15:0-18:1(d7) DAG",
    "LPC" = "18:1(d7) Lyso PC",
    "LPE" = "18:1(d7) Lyso PE",
    "MG" = "18:1 (d7) MG",
    "PA" = "15:0-18:1(d7) PA (Na Salt)",
    "PC" = "15:0-18:1(d7) PC",
    "PE" = "15:0-18:1(d7) PE",
    "PG" = "15:0-18:1(d7) PG (Na Salt)",
    "PI" = "15:0-18:1(d7) PI (NH4 Salt)",
    "PPE" = "C18(Plasm)-18:1(d9) PE",
    "PS" = "15:0-18:1(d7) PS (Na Salt)",
    "SM" = "d18:1-18:1(d9) SM",
    "TG" = "15:0-18:1(d7)-15:0 TAG"
  )
```

* Negative mode:

```{r, eval=TRUE, warning=FALSE, cache=TRUE}
match_item_neg =
  list(
    "Cer" = "d18:1 (d7)-15:0 Cer",
    "Chol" = "Cholesterol (d7)",
    "ChE" = c("18:1(d7) Chol Ester", "Cholesterol (d7)"),
    "LPC" = "18:1(d7) Lyso PC",
    "LPE" = "18:1(d7) Lyso PE",
    "PC" = "15:0-18:1(d7) PC",
    "PE" = "15:0-18:1(d7) PE",
    "PG" = "15:0-18:1(d7) PG (Na Salt)",
    "PI" = "15:0-18:1(d7) PI (NH4 Salt)",
    "PPE" = "C18(Plasm)-18:1(d9) PE",
    "PS" = "15:0-18:1(d7) PS (Na Salt)",
    "SM" = "d18:1-18:1(d9) SM"
  )
```

## **Run `get_lipid_absolute_quantification()` function**

Then we run `get_lipid_absolute_quantification()` function. Please note that `path` need to set as `example`.

```{r, eval=TRUE, warning=FALSE, error=FALSE, message=FALSE, cache=TRUE}
get_lipid_absolute_quantification(
  path = "example",
  is_info_name_pos = "IS_information.xlsx",
  is_info_name_neg = "IS_information.xlsx",
  use_manual_is_info = FALSE,
  lipid_annotation_table_pos = "lipid_annotation_table_pos.xlsx",
  lipid_annotation_table_neg = "lipid_annotation_table_neg.xlsx",
  output_eic = TRUE,
  ppm = 40,
  rt.tolerance = 180,
  threads = 3,
  rerun = FALSE,
  which_group_for_rt_confirm = "D25",
  match_item_pos = match_item_pos,
  match_item_neg = match_item_neg
)
```

# **Output result**

Most of the results are outputted in `example/Result`, some results are in `example/POS` and `example/NEG`.

## **Information of all internal standards**

Here we set `which_group_for_rt_confirm` as "D25", so this group samples will be used to extract internal standards and get the information of all IS.

The RTs of internal standards are generated automatically, and outputted as `IS_info_nex.xlsx` in "example/POS" and "example/NEG", respectively. 

![](../man/figures/figure5.png)

We can see that `lipidflow` added the `rt`, `adduct` and `mz` in the `IS_info_new.xlsx`. If there are no good EICs of one IS, no information for these ISs.

Sometimes the information of ISs maybe not correct, you can open the EICs of each internal standard and then check the RTs and then put all the correct RTs, adducts and m/z of internal standards in your IS information table. The EICs for each IS is in the `example/POS/Result/peak_shape` folder.

![](../man/figures/figure6.png)

One example is like below figure shows:

```{r, echo=FALSE, eval=TRUE}
htmltools::tags$iframe(
  title = "Internal standard",
  src = "../man/figures/15_0-18_1d7_PA_Na_Salt_M+H.html",
  width = "100%",
  height = "600",
  scrolling = "no",
  seamless = "seamless",
  frameBorder = "0"
)
```

## **Final results for absolute quantification of lipids**

All the results for absolute quantification of lipids are in `example/Result`. 

![](../man/figures/figure8.png)

1. `IS_info_table.xlsx`

This table is the information for internal standards in positive and negative mode, respectively.

![](../man/figures/figure7.png)

2. `lipid_data_class_ug_ml.xlsx`

![](../man/figures/figure9.png)

3. `lipid_data_class_um_per.xlsx`

![](../man/figures/figure10.png)

4. `lipid_data_class_um.xlsx`

![](../man/figures/figure11.png)

5. `lipid_data_ug_ml.xlsx`

![](../man/figures/figure12.png)

6. `lipid_data_um_per.xlsx`

![](../man/figures/figure13.png)

7. `lipid_data_um.xlsx`

![](../man/figures/figure14.png)

8. `plot_ug.pdf` and `plot_um.pdf`

![](../man/figures/figure15.png)

![](../man/figures/figure16.png)

9. `class_data_ug_ml.xlsx` and `class_data_um.xlsx`

![](../man/figures/figure17.png)

![](../man/figures/figure18.png)

10. `class_plot`

![](../man/figures/figure19.png)

11. `intensity_plot`

![](../man/figures/figure20.png)
![](../man/figures/figure21.png)

